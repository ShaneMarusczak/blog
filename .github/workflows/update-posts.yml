name: Update posts.json

on:
  push:
    branches: [main]
    paths:
      - 'posts/**.html'

  workflow_dispatch:

permissions:
  contents: write

jobs:
  update-manifest:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Generate posts.json
        run: |
          python3 << 'SCRIPT'
          import os, json, re

          posts_dir = "posts"
          posts = []

          def extract_meta(html, name):
              """Extract content from <meta name="X" content="Y"> in either attribute order."""
              patterns = [
                  rf'<meta\s+name="{name}"\s+content="([^"]*)"',
                  rf'<meta\s+content="([^"]*)"\s+name="{name}"',
              ]
              for pattern in patterns:
                  match = re.search(pattern, html, re.IGNORECASE)
                  if match:
                      return match.group(1)
              return ""

          def extract_title(html):
              match = re.search(r'<title>([^<]+)</title>', html, re.IGNORECASE)
              return match.group(1).strip() if match else ""

          for filename in sorted(os.listdir(posts_dir)):
              if not filename.endswith(".html"):
                  continue
              filepath = os.path.join(posts_dir, filename)
              with open(filepath, "r", encoding="utf-8") as f:
                  html = f.read()

              title = extract_title(html)
              date = extract_meta(html, "date")
              category = extract_meta(html, "category")
              description = extract_meta(html, "description")

              if not title:
                  title = filename.replace(".html", "").replace("-", " ").title()

              posts.append({
                  "file": filename,
                  "title": title,
                  "date": date,
                  "category": category,
                  "description": description,
              })

          posts.sort(key=lambda p: p["date"], reverse=True)

          with open("posts.json", "w", encoding="utf-8") as f:
              json.dump(posts, f, indent=2, ensure_ascii=False)
              f.write("\n")

          print(f"Generated posts.json with {len(posts)} post(s)")
          SCRIPT

      - name: Commit updated posts.json
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add posts.json
          git diff --cached --quiet && echo "No changes to commit" && exit 0
          git commit -m "Update posts.json [automated]"
          git push
